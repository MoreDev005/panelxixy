<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files - Xixy Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs/loader.min.js"></script>
    <style>
        body { background-color: #0d1117; color: white; display: flex; flex-direction: column; min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        .bg-ptero-card { background-color: #161b22; }
        .logo-glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.2); }
        main { flex: 1; }
        
        @media (max-width: 768px) {
            .file-actions { opacity: 1 !important; }
            #editorModal { padding: 10px; }
            .hide-mobile { display: none; }
        }
        @media (min-width: 769px) {
            tr:hover .file-actions { opacity: 1; }
            .file-actions { opacity: 0; transition: opacity 0.2s; }
        }

        #editorModal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; }
        #editorContainer { height: calc(100vh - 120px); border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .custom-scroll::-webkit-scrollbar { height: 4px; width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body>
    <nav class="p-4 border-b border-gray-800 flex justify-between items-center px-6 md:px-10 bg-ptero-card sticky top-0 z-50">
        <div class="flex items-center gap-4 cursor-pointer" onclick="location.href='/home'">
            <div class="logo-glow w-10 h-10 md:w-11 md:h-11 rounded-full overflow-hidden p-1.5 flex items-center justify-center bg-[#0d1117]">
                <img src="/logo.png" onerror="this.src='https://ui-avatars.com/api/?name=P&background=3b82f6&color=fff'" class="w-full h-full object-cover rounded-full">
            </div>
            <div class="flex flex-col">
                <h1 class="text-white font-black tracking-tighter text-lg leading-none uppercase">Xixy Panel</h1>
                <div class="flex items-center gap-1.5">
                    <span class="w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse"></span>
                    <span class="text-[9px] text-blue-500 font-bold tracking-[0.2em] uppercase italic">File Manager</span>
                </div>
            </div>
        </div>
        <a href="/home" class="text-[10px] font-bold text-gray-500 hover:text-white transition uppercase tracking-widest">Home</a>
    </nav>

    <div class="bg-gray-900 border-b border-gray-800 flex gap-6 px-6 md:px-10 text-[10px] font-bold uppercase tracking-widest overflow-x-auto whitespace-nowrap custom-scroll">
        <a id="lnk-c" class="py-4 text-gray-500">Console</a>
        <a id="lnk-f" class="py-4 border-b-2 border-blue-500 text-white">Files</a>
        <a id="lnk-s" class="py-4 text-gray-500">Settings</a>
        <a id="lnk-t" class="py-4 text-gray-500">Terminal</a>
    </div>

    <main class="p-4 md:p-10 max-w-6xl mx-auto w-full">
        <div class="mb-6 flex items-center gap-2 text-[11px] font-mono bg-gray-900/50 p-3 rounded-xl border border-gray-800 overflow-x-auto whitespace-nowrap custom-scroll">
            <button onclick="changeDir('')" class="text-blue-500 hover:text-blue-400 font-bold uppercase tracking-tighter flex items-center gap-1"><i class="bi bi-hdd-network"></i> root</button>
            <div id="breadcrumb-list" class="flex items-center gap-2 text-gray-500"></div>
        </div>

        <div id="uploadProgressContainer" class="fixed bottom-10 right-6 left-6 md:left-auto md:w-80 bg-gray-900 border border-gray-800 rounded-2xl p-4 shadow-2xl hidden z-[1001]">
            <div class="flex justify-between items-center mb-3">
                <span class="text-[10px] font-bold uppercase tracking-widest text-blue-400">Uploading...</span>
                <span id="progressPercent" class="text-[10px] font-mono text-white">0%</span>
            </div>
            <div class="w-full bg-gray-800 rounded-full h-1.5 overflow-hidden"><div id="progressBar" class="bg-blue-500 h-full w-0 transition-all"></div></div>
        </div>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <h2 class="text-2xl font-bold tracking-tight">File Manager</h2>
            <div class="flex flex-wrap gap-2 w-full md:w-auto">
                <div id="mass-actions" class="hidden flex gap-2 w-full md:w-auto">
                    <button onclick="moveSelected()" class="flex-1 md:flex-none bg-purple-600/20 text-purple-400 border border-purple-500/30 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition flex items-center justify-center gap-2"><i class="bi bi-arrows-move"></i> <span class="hide-mobile">Move</span></button>
                    <button onclick="archiveSelected()" class="flex-1 md:flex-none bg-yellow-600/20 text-yellow-500 border border-yellow-500/30 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition flex items-center justify-center gap-2"><i class="bi bi-file-zip"></i> <span class="hide-mobile">Archive</span></button>
                    <button onclick="deleteSelected()" class="flex-1 md:flex-none bg-red-600/20 text-red-500 border border-red-500/30 px-3 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition flex items-center justify-center gap-2"><i class="bi bi-trash"></i> <span class="hide-mobile">Delete</span></button>
                </div>
                <button onclick="document.getElementById('fileInput').click()" class="flex-1 md:flex-none bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition flex items-center justify-center gap-2"><i class="bi bi-upload"></i> Upload</button>
                <input type="file" id="fileInput" class="hidden" onchange="uploadFile(this)">
                <button onclick="createNewFile()" class="flex-1 md:flex-none bg-gray-800 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition flex items-center justify-center gap-2"><i class="bi bi-plus-lg"></i> New File</button>
                <button onclick="createNewFolder()" class="flex-1 md:flex-none bg-gray-800 px-4 py-2 rounded-xl text-[10px] font-bold uppercase tracking-widest transition flex items-center justify-center gap-2">
                    <i class="bi bi-folder-plus"></i> New Folder
                </button>
            </div>
        </div>

        <div class="bg-ptero-card border border-gray-800 rounded-2xl overflow-hidden shadow-2xl">
            <div class="overflow-x-auto custom-scroll">
                <table class="w-full text-left text-xs">
                    <thead class="bg-gray-900/80 text-gray-500 font-bold uppercase tracking-widest">
                        <tr>
                            <th class="p-4 w-10 text-center"><input type="checkbox" id="main-check" onclick="selAll(this.checked)" class="w-4 h-4 rounded border-gray-700 bg-gray-800 cursor-pointer"></th>
                            <th class="p-4">Name</th>
                            <th class="p-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="flist" class="divide-y divide-gray-800/50"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="editorModal">
        <div class="max-w-6xl mx-auto bg-[#1e1e1e] rounded-xl overflow-hidden shadow-2xl border border-gray-700 flex flex-col h-full md:h-auto">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-[#252526]">
                <span id="editingFileName" class="text-[10px] font-mono text-blue-400 font-bold truncate pr-4">file.js</span>
                <div class="flex gap-2">
                    <button onclick="closeEditor()" class="text-[10px] font-bold text-gray-400 uppercase tracking-widest px-2">Cancel</button>
                    <button onclick="saveFile()" class="bg-blue-600 hover:bg-blue-700 px-4 py-1.5 rounded-lg text-[10px] font-bold uppercase tracking-widest transition">Save</button>
                </div>
            </div>
            <div id="editorContainer"></div>
        </div>
    </div>

    <footer class="bg-ptero-card border-t border-gray-800 p-8 mt-10">
        <div class="max-w-6xl mx-auto flex justify-center md:justify-start items-center gap-3">
            <div class="w-8 h-8 rounded-full border border-gray-800 overflow-hidden p-1">
                <img src="/logo.png" onerror="this.src='https://ui-avatars.com/api/?name=P&background=3b82f6&color=fff'" class="w-full h-full object-cover rounded-full opacity-40">
            </div>
            <p class="text-[10px] text-gray-600 font-bold uppercase tracking-widest">&copy; 2026 Xixy Panel ‚Ä¢ File Manager</p>
        </div>
    </footer>

    <script>
        const parts = window.location.pathname.split('/').filter(p => p.length > 0);
        const name = parts[1];
        let currentDir = ""; // Track current directory
        let editor;
        let currentEditingPath = "";

        // Navigation Links
        document.getElementById('lnk-c').href = `/dashboard/${name}/console`;
        document.getElementById('lnk-f').href = `/dashboard/${name}/files`;
        document.getElementById('lnk-s').href = `/dashboard/${name}/settings`;
        document.getElementById('lnk-t').href = `/dashboard/${name}/terminal`;

        // Monaco Editor Init
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.44.0/min/vs' }});
        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editorContainer'), {
                value: "", language: 'javascript', theme: 'vs-dark', automaticLayout: true, fontSize: 14, fontFamily: 'monospace', minimap: { enabled: false }
            });
        });

        // Breadcrumb logic
        function updateBreadcrumbs() {
            const bc = document.getElementById('breadcrumb-list');
            if (!currentDir) { bc.innerHTML = ""; return; }
            const folders = currentDir.split('/');
            let pathAcc = "";
            bc.innerHTML = folders.map((f, i) => {
                pathAcc += (i === 0 ? f : '/' + f);
                const thisPath = pathAcc;
                return `<span>/</span><button onclick="changeDir('${thisPath}')" class="text-blue-400 hover:underline">${f}</button>`;
            }).join('');
        }
        
        async function load(dir = "") {
        currentDir = dir; // Simpan path folder yang sedang dibuka
        updateBreadcrumbs();
        
        try {
        const r = await fetch(`/api/files?appName=${name}&dir=${encodeURIComponent(currentDir)}`);
        const data = await r.json();
        const tb = document.getElementById('flist');
        
        if (!data || data.length === 0) {
        tb.innerHTML = `<tr>
          <td colspan="3" class="p-10 text-center text-gray-500 uppercase tracking-widest text-[10px]">Folder Kosong</td>
        </tr>`;
        return;
        }
        
        tb.innerHTML = data.map(f => {
        // Gabungkan path untuk aksi selanjutnya (delete/edit/masuk folder)
        const fullPath = currentDir ? `${currentDir}/${f.name}` : f.name;
        const isZip = f.name.toLowerCase().match(/\.(zip|tar\.gz|tgz)$/);
        
        return `
        <tr class="group hover:bg-gray-800/30 transition">
          <td class="p-4 text-center"><input type="checkbox" class="f-sel w-4 h-4 rounded border-gray-700 bg-gray-900 cursor-pointer" value="${fullPath}" onchange="chk()">
          </td>
          <td class="p-4">
            <div class="flex items-center gap-3">
              <span class="text-lg">${f.isDirectory ? 'üìÅ' : (isZip ? 'üì¶' : 'üìÑ')}</span>
              <span class="font-medium text-gray-200 group-hover:text-blue-400 transition cursor-pointer truncate"
                                      onclick="${f.isDirectory ? `load('${fullPath}')` : `openEditor('${fullPath}')`}">
                                    ${f.name}
                                </span>
            </div>
          </td>
          <td class="p-4 text-right">
            <div class="file-actions flex justify-end gap-3 md:gap-4">
              <button onclick="moveFile('${fullPath}','${f.name}')" class="text-gray-500 hover:text-purple-400"><i class="bi bi-arrows-move"></i></button>
              <button title="Rename" onclick="renameFile('${fullPath}','${f.name}')" class="text-gray-500 hover:text-yellow-500"><i class="bi bi-fonts"></i></button>
              ${!f.isDirectory ? `
              ${isZip ? `<button title="Unarchive" onclick="unarchive('${fullPath}')" class="text-yellow-500"><i class="bi bi-box-arrow-up"></i></button>` : ''}
              <button onclick="openEditor('${fullPath}')" class="text-gray-500 hover:text-blue-500"><i class="bi bi-pencil-square"></i></button>
              <a href="/api/files/download?appName=${name}&filePath=${encodeURIComponent(fullPath)}"
                class="text-gray-500 hover:text-green-500"><i class="bi bi-download"></i></a>
              ` : ''}
              <button onclick="deleteFile('${fullPath}')" class="text-gray-500 hover:text-red-500"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>`;
        }).join('');
        } catch (e) {
        console.error("Gagal load file:", e);
        }
        }
        
        // Fungsi untuk navigasi balik lewat Breadcrumbs
        function updateBreadcrumbs() {
        const bc = document.getElementById('breadcrumb-list');
        if (!currentDir) { bc.innerHTML = ""; return; }
        
        const folders = currentDir.split('/');
        let pathAcc = "";
        bc.innerHTML = folders.map((f, i) => {
        pathAcc += (i === 0 ? f : '/' + f);
        const thisPath = pathAcc;
        return `<span>/</span><button onclick="load('${thisPath}')" class="text-blue-400 hover:underline">${f}</button>`;
        }).join('');
        }

        function changeDir(newDir) { load(newDir); }

        function chk() {
        const selectedCount = document.querySelectorAll('.f-sel:checked').length;
        const massActions = document.getElementById('mass-actions');
        if (selectedCount > 0) {
        massActions.classList.remove('hidden');
        massActions.classList.add('flex');
        } else {
        massActions.classList.add('hidden');
        massActions.classList.remove('flex');
        }
        }

        // UI Resetters
        function resetSelection() {
        const mainCheck = document.getElementById('main-check');
        if (mainCheck) mainCheck.checked = false;
        chk();
        }


        function selAll(s) {
            document.querySelectorAll('.f-sel').forEach(c => c.checked = s);
            chk();
        }

        function uploadFile(input) {
            if (!input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            formData.append('appName', name);
            formData.append('currentDir', currentDir); // Target the current folder

            const container = document.getElementById('uploadProgressContainer');
            const bar = document.getElementById('progressBar');
            const percentText = document.getElementById('progressPercent');
            container.classList.remove('hidden');

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/files/upload', true);
            xhr.upload.onprogress = (e) => {
                if (e.lengthComputable) {
                    const percent = Math.round((e.loaded / e.total) * 100);
                    bar.style.width = percent + '%';
                    percentText.innerText = percent + '%';
                }
            };
            xhr.onload = () => { setTimeout(() => { container.classList.add('hidden'); bar.style.width = '0%'; load(currentDir); }, 1000); };
            xhr.send(formData);
            input.value = '';
        }

        async function moveFile(f,fd) {
            const newPath = prompt("Rename or Move to path (relative to root):", fd);
            if(newPath && newPath !== f) {
                await fetch('/api/files/rename', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, oldPath:f, newPath:newPath})});
                load(currentDir);
            }
        }

        async function moveSelected() {
            const files = Array.from(document.querySelectorAll('.f-sel:checked')).map(cb => cb.value);
            const targetFolder = prompt("Move selected items to folder (relative to root, e.g. 'src/'):", "");
            if(targetFolder === null) return;
            for(const f of files) {
                const fileName = f.split('/').pop();
                const target = targetFolder + (targetFolder.endsWith('/') || targetFolder === "" ? "" : "/") + fileName;
                await fetch('/api/files/rename', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, oldPath:f, newPath:target})});
            }
            await load(currentDir);
            resetSelection(); // Sembunyikan tombol
        }

        async function openEditor(path) {
            currentEditingPath = path;
            document.getElementById('editingFileName').innerText = path;
            const r = await fetch(`/api/files/content?appName=${name}&filePath=${encodeURIComponent(path)}`);
            const data = await r.json();
            const ext = path.split('.').pop().toLowerCase();
            const langs = { js:'javascript', json:'json', html:'html', css:'css', py:'python', md:'markdown' };
            monaco.editor.setModelLanguage(editor.getModel(), langs[ext] || 'plaintext');
            editor.setValue(data.content || "");
            document.getElementById('editorModal').style.display = 'block';
        }

        async function saveFile() {
            const content = editor.getValue();
            await fetch('/api/files/save', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, filePath:currentEditingPath, content })});
            closeEditor();
            load(currentDir);
        }

        function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }
        
        async function archiveSelected() {
            const files = Array.from(document.querySelectorAll('.f-sel:checked')).map(cb => cb.value);
            const zipName = prompt("Zip name (saved in current folder):", "archive.zip");
            if(zipName) { 
                const fullZipPath = currentDir ? `${currentDir}/${zipName}` : zipName;
                await fetch('/api/files/archive', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, files, zipName: fullZipPath})}); 
                await load(currentDir);
                resetSelection(); // Sembunyikan tombol
            }
        }

        async function unarchive(f) { 
            if(confirm(`Extract ${f} in current folder?`)) { 
                await fetch('/api/files/unarchive', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, filePath:f, outputDir: currentDir})}); 
                load(currentDir); 
            } 
        }

        async function deleteSelected() {
            const files = Array.from(document.querySelectorAll('.f-sel:checked')).map(cb => cb.value);
            if(confirm(`Delete ${files.length} items?`)) { 
                for(const f of files) await fetch('/api/files/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, filePath:f})}); 
                await load(currentDir);
                resetSelection(); // Sembunyikan tombol
            }
        }

        async function deleteFile(f) { if(confirm(`Delete ${f}?`)) { await fetch('/api/files/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, filePath:f})}); load(currentDir); }}
        
        async function createNewFile() { 
            const f = prompt("Filename (inside current folder):"); 
            if(f) { 
                const path = currentDir ? `${currentDir}/${f}` : f;
                await fetch('/api/files/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, filePath:path, content:""})}); 
                load(currentDir); 
            } 
        }

        async function renameFile(f,fd) { 
          const n = prompt("New name:", fd); 
          if(n) { 
            await fetch('/api/files/rename',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({appName:name, oldPath:f, newPath:n})}); 
            load(currentDir); 
        }
        }

        async function createNewFolder() {
        const folderName = prompt("Nama folder baru:");
        if (!folderName) return;
        
        // Gabungkan dengan currentDir agar folder dibuat di posisi saat ini
        const path = currentDir ? `${currentDir}/${folderName}` : folderName;
        
        try {
        const response = await fetch('/api/files/mkdir', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
        appName: name,
        path: path
        })
        });
        
        if (response.ok) {
        load(currentDir); // Refresh folder saat ini
        } else {
        const err = await response.json();
        alert("Gagal membuat folder: " + (err.error || "Unknown error"));
        }
        } catch (e) {
        console.error(e);
        alert("Terjadi kesalahan pada koneksi.");
        }
        }
        

        load();
    </script>
</body>
</html>